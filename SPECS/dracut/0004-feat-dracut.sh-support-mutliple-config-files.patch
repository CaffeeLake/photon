From 986e00a2f12b914222687cf1052ebc7e80f09160 Mon Sep 17 00:00:00 2001
From: Shreenidhi Shedi <sshedi@vmware.com>
Date: Sat, 18 Feb 2023 18:30:46 +0530
Subject: [PATCH 4/4] feat(dracut.sh): support mutliple config files

Add provision to specify multiple config files.

Signed-off-by: Shreenidhi Shedi <sshedi@vmware.com>
---
 dracut.sh        | 38 +++++++++++++++++++++++---------------
 man/dracut.8.asc |  4 ++--
 2 files changed, 25 insertions(+), 17 deletions(-)

diff --git a/dracut.sh b/dracut.sh
index 0088ad1..6c0c71e 100755
--- a/dracut.sh
+++ b/dracut.sh
@@ -152,8 +152,8 @@ Creates initial ramdisk images for preloading modules
                          6 - trace info (and even more)
   -v, --verbose         Increase verbosity level.
   -q, --quiet           Decrease verbosity level.
-  -c, --conf [FILE]     Specify configuration file to use.
-                         Default: /etc/dracut.conf
+  -c, --conf [LIST]     Specify a space separated list of configuration files
+                         to use. Default: /etc/dracut.conf
   --confdir [LIST]      Specify a space separated list of configuration
                          directories to use *.conf files from.
                          Default: /etc/dracut.conf.d
@@ -664,7 +664,7 @@ while :; do
             shift
             ;;
         -c | --conf)
-            conffile="$2"
+            conffiles_l="$2"
             PARMS_TO_STORE+=" '$2'"
             shift
             ;;
@@ -901,15 +901,21 @@ export DRACUT_LOG_LEVEL=warning
 [[ $dracutbasedir ]] || dracutbasedir="$dracutsysrootdir"/usr/lib/dracut
 
 # if we were not passed a config file, try the default one
-if [[ -z $conffile ]]; then
+if [ ${#conffiles_l[@]} -eq 0 ]; then
     if [[ $allowlocal ]]; then
-        conffile="$dracutbasedir/dracut.conf"
+        conffiles="$dracutbasedir/dracut.conf"
     else
-        conffile="$dracutsysrootdir/etc/dracut.conf"
+        conffiles="$dracutsysrootdir/etc/dracut.conf"
     fi
-elif [[ ! -e $conffile ]]; then
-    printf "%s\n" "dracut: Configuration file '$conffile' not found." >&2
-    exit 1
+else
+    # shellcheck disable=SC2068
+    for f in ${conffiles_l[@]}; do
+        if [[ ! -e $f ]]; then
+            printf "%s\n" "dracut: Configuration file '$f' not found." >&2
+            exit 1
+        fi
+        conffiles+=" $f"
+    done
 fi
 
 if [ ${#confdirs_l[@]} -eq 0 ]; then
@@ -929,12 +935,14 @@ else
     done
 fi
 
-# source our config file
-if [[ -f $conffile ]]; then
-    check_conf_file "$conffile"
-    # shellcheck disable=SC1090
-    . "$conffile"
-fi
+# source all config files
+for f in $conffiles; do
+    if [[ -f $f ]]; then
+        check_conf_file "$f"
+        # shellcheck disable=SC1090
+        . "$f"
+    fi
+done
 
 # source config files from all config dirs
 # shellcheck disable=SC2086
diff --git a/man/dracut.8.asc b/man/dracut.8.asc
index 3eddb5a..0d9fe48 100644
--- a/man/dracut.8.asc
+++ b/man/dracut.8.asc
@@ -299,8 +299,8 @@ example:
 **-q, --quiet**::
     Decrease verbosity level (default is info(4)).
 
-**-c, --conf** _<dracut configuration file>_::
-    Specify configuration file to use.
+**-c, --conf** _<list of dracut configuration files>_::
+    Specify a space-separated list of configuration files to use.
 +
 Default:
    _/etc/dracut.conf_
-- 
2.39.2

